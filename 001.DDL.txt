CREATE DATABASE delivery_ops;

CREATE TABLE Customer(
  id SERIAL PRIMARY KEY,
  name VARCHAR(20),
  email VARCHAR(20)
);

CREATE TABLE Seller(
  id SERIAL PRIMARY KEY,
  name VARCHAR(20),
  email VARCHAR(20)
);

CREATE TABLE Categories (
  id SERIAL PRIMARY KEY,
  name VARCHAR(20)
);


CREATE TABLE Product(
  id SERIAL PRIMARY KEY,
  name VARCHAR(20),
  price DECIMAL(10,2) NOT NULL CHECK(price>0),
  seller_id INTEGER REFERENCES seller(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  category_id INTEGER REFERENCES categories(id) ON DELETE RESTRICT ON UPDATE CASCADE
);


CREATE TABLE orders (
id SERIAL PRIMARY KEY,
customer_id INTEGER NOT NULL REFERENCES customer(id) ON DELETE RESTRICT ON UPDATE CASCADE,
status VARCHAR(20) DEFAULT 'CREATED',
amount DECIMAL (12,2) DEFAULT 0 CHECK (amount >= 0)
);


CREATE TABLE order_items (
id SERIAL PRIMARY KEY,
order_id INTEGER NOT NULL REFERENCES orders(id) ON DELETE RESTRICT ON UPDATE CASCADE,
product_id INTEGER NOT NULL REFERENCES product(id) ON DELETE RESTRICT ON UPDATE CASCADE,
quantity INTEGER NOT NULL CHECK (quantity > 0),
unit_price DECIMAL(10,2) NOT NULL CHECK (unit_price>0),
subtotal DECIMAL(10,2) GENERATED ALWAYS AS (quantity * unit_price) STORED

);


CREATE TYPE payment_status AS ENUM ('PENDING', 'APPROVED', 'FAILED', 'REFUNDED');
CREATE TYPE order_status AS ENUM ('CREATED', 'PAID', 'IN_PROGRESS', 'DELIVERED', 'CANCELED', 'REFUNDED');

DROP TABLE IF EXISTS payment_status CASCADE;

CREATE TABLE payments (
  id SERIAL PRIMARY KEY,
  order_id INTEGER NOT NULL REFERENCES orders(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  payment_status_id INTEGER NOT NULL REFERENCES payment_status(id) ON DELETE RESTRICT ON UPDATE CASCADE,
  amount DECIMAL(12,2) NOT NULL CHECK (amount > 0)
)

CREATE TABLE fulfillments(
id SERIAL PRIMARY KEY,
order_id INTEGER NOT NULL UNIQUE REFERENCES orders(id) ON DELETE RESTRICT ON UPDATE CASCADE,
created_at DATE NOT NULL,
finish_at DATE NOT NULL
);

CREATE TYPE order_status AS ENUM (
  'CREATED', 'PAID', 'IN_PROGRESS', 'DELIVERED', 'CANCELED', 'REFUNDED'

);

CREATE TABLE order_status_history(
id SERIAL PRIMARY KEY,
order_id INTEGER NOT NULL REFERENCES orders(id) ON DELETE RESTRICT ON UPDATE CASCADE,
from_status order_status,
to_status order_status NOT NULL,
change_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
change_by VARCHAR(30) DEFAULT 'system'

);
